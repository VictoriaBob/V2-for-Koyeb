FROM nginx:latest
EXPOSE 80
WORKDIR /app
USER root

COPY nginx.conf /etc/nginx/nginx.conf
COPY entrypoint.sh ./

RUN apt-get update && apt-get install -y wget unzip iproute2 systemctl &&\
    wget -O temp.zip $(wget -qO- "https://api.github.com/repos/v2fly/v2ray-core/releases/latest" | grep -m1 -o "https.*linux-64.*zip") &&\
    unzip temp.zip v2ray geoip.dat geosite.dat &&\
    mv v2ray v &&\
    rm -f temp.zip &&\
    chmod -v 755 v entrypoint.sh &&\
    echo 'ewogICAgImxvZyI6IHsKICAgICAgICAibG9nbGV2ZWwiOiAid2FybmluZyIsCiAgICAgICAgImFjY\
2VzcyI6ICIvZGV2L251bGwiLAogICAgICAgICJlcnJvciI6ICIvZGV2L251bGwiCiAgICB9LAogIC\
AgImluYm91bmRzIjogWwogICAgICAgIHsKICAgICAgICAgICAgInBvcnQiOiAxMDAwMCwKICAgICA\
gICAgICAgInByb3RvY29sIjogInZtZXNzIiwKICAgICAgICAgICAgImxpc3RlbiI6ICIxMjcuMC4w\
LjEiLAogICAgICAgICAgICAic2V0dGluZ3MiOiB7CiAgICAgICAgICAgICAgICAiY2xpZW50cyI6I\
FsKICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgICJpZCI6ICJVVU\
lEIiwKICAgICAgICAgICAgICAgICAgICAgICAgImFsdGVySWQiOiAwCiAgICAgICAgICAgICAgICA\
gICAgfQogICAgICAgICAgICAgICAgXQogICAgICAgICAgICB9LAogICAgICAgICAgICAic3RyZWFt\
U2V0dGluZ3MiOiB7CiAgICAgICAgICAgICAgICAidHJhbnNwb3J0IjogImh0dHB1cGdyYWRlIiwKI\
CAgICAgICAgICAgICAgICJ0cmFuc3BvcnRTZXR0aW5ncyI6IHsKICAgICAgICAgICAgICAgICAgIC\
AicGF0aCI6ICJWTUVTU19XU1BBVEgiCiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICA\
gICAgICB9LAogICAgICAgIHsKICAgICAgICAgICAgInBvcnQiOiAyMDAwMCwKICAgICAgICAgICAg\
InByb3RvY29sIjogInZsZXNzIiwKICAgICAgICAgICAgImxpc3RlbiI6ICIxMjcuMC4wLjEiLAogI\
CAgICAgICAgICAic2V0dGluZ3MiOiB7CiAgICAgICAgICAgICAgICAiY2xpZW50cyI6IFsKICAgIC\
AgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgICJpZCI6ICJVVUlEIgogICA\
gICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIF0sCiAgICAgICAgICAgICAgICAiZGVj\
cnlwdGlvbiI6ICJub25lIgogICAgICAgICAgICB9LAogICAgICAgICAgICAic3RyZWFtU2V0dGluZ\
3MiOiB7CiAgICAgICAgICAgICAgICAidHJhbnNwb3J0IjogImh0dHB1cGdyYWRlIiwKICAgICAgIC\
AgICAgICAgICJ0cmFuc3BvcnRTZXR0aW5ncyI6IHsKICAgICAgICAgICAgICAgICAgICAicGF0aCI\
6ICJWTEVTU19XU1BBVEgiCiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9\
CiAgICBdLAogICAgIm91dGJvdW5kcyI6IFsKICAgICAgICB7CiAgICAgICAgICAgICJwcm90b2Nvb\
CI6ICJmcmVlZG9tIiwKICAgICAgICAgICAgInNldHRpbmdzIjoge30KICAgICAgICB9CiAgICBdLA\
ogICAgImRucyI6IHsKICAgICAgICAic2VydmVycyI6IFsKICAgICAgICAgICAgIjguOC44LjgiLAo\
gICAgICAgICAgICAiOC44LjQuNCIsCiAgICAgICAgICAgICJsb2NhbGhvc3QiCiAgICAgICAgXQog\
ICAgfQp9' > config

ENTRYPOINT [ "./entrypoint.sh" ]
