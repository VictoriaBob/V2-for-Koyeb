FROM nginx:latest
EXPOSE 80
WORKDIR /app
USER root

COPY nginx.conf /etc/nginx/nginx.conf
COPY entrypoint.sh ./

RUN apt-get update && apt-get install -y wget unzip iproute2 systemctl &&\
    wget -O temp.zip "https://github.com/XTLS/Xray-core/releases/download/v25.3.6/Xray-linux-64.zip" &&\
    unzip temp.zip xray geoip.dat geosite.dat &&\
    mv xray v &&\
    rm -f temp.zip &&\
    chmod -v 755 v entrypoint.sh &&\
    echo 'ewogICAgImxvZyI6IHsKICAgICAgICAibG9nbGV2ZWwiOiAid2FybmluZyIsCiAgICAgICAgImFjY2\
VzcyI6ICIvZGV2L251bGwiLAogICAgICAgICJlcnJvciI6ICIvZGV2L251bGwiCiAgICB9LAogICAg\
ImluYm91bmRzIjogWwogICAgICAgIHsKICAgICAgICAgICAgInBvcnQiOiAxMDAwMCwKICAgICAgIC\
AgICAgInByb3RvY29sIjogInZsZXNzIiwKICAgICAgICAgICAgImxpc3RlbiI6ICIxMjcuMC4wLjEi\
LAogICAgICAgICAgICAic2V0dGluZ3MiOiB7CiAgICAgICAgICAgICAgICAiY2xpZW50cyI6IFsKIC\
AgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgICJpZCI6ICJVVUlEIgog\
ICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIF0sCiAgICAgICAgICAgICAgICAiZG\
VjcnlwdGlvbiI6ICJub25lIgogICAgICAgICAgICB9LAogICAgICAgICAgICAic3RyZWFtU2V0dGlu\
Z3MiOiB7CiAgICAgICAgICAgICAgICAibmV0d29yayI6ICJ4aHR0cCIsCiAgICAgICAgICAgICAgIC\
AieGh0dHBTZXR0aW5ncyI6IHsKICAgICAgICAgICAgICAgICAgICAicGF0aCI6ICJWTEVTU19YSFRU\
UFBBVEgiCiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgICJzbmlmZm\
luZyI6IHsKICAgICAgICAgICAgICAgICJlbmFibGVkIjogdHJ1ZSwKICAgICAgICAgICAgICAgICJk\
ZXN0T3ZlcnJpZGUiOiBbCiAgICAgICAgICAgICAgICAgICAgImh0dHAiLAogICAgICAgICAgICAgIC\
AgICAgICJ0bHMiLAogICAgICAgICAgICAgICAgICAgICJxdWljIgogICAgICAgICAgICAgICAgXQog\
ICAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICB7CiAgICAgICAgICAgICJwb3J0IjogMjAwMD\
AsCiAgICAgICAgICAgICJwcm90b2NvbCI6ICJ2bGVzcyIsCiAgICAgICAgICAgICJsaXN0ZW4iOiAi\
MTI3LjAuMC4xIiwKICAgICAgICAgICAgInNldHRpbmdzIjogewogICAgICAgICAgICAgICAgImNsaW\
VudHMiOiBbCiAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICAiaWQi\
OiAiVVVJRCIKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBdLAogICAgICAgIC\
AgICAgICAgImRlY3J5cHRpb24iOiAibm9uZSIKICAgICAgICAgICAgfSwKICAgICAgICAgICAgInN0\
cmVhbVNldHRpbmdzIjogewogICAgICAgICAgICAgICAgIm5ldHdvcmsiOiAid3MiLAogICAgICAgIC\
AgICAgICAgIndzU2V0dGluZ3MiOiB7CiAgICAgICAgICAgICAgICAgICAgInBhdGgiOiAiVkxFU1Nf\
V1NQQVRIIgogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQogICAgXSwKIC\
AgICJvdXRib3VuZHMiOiBbCiAgICAgICAgewogICAgICAgICAgICAicHJvdG9jb2wiOiAiZnJlZWRv\
bSIsCiAgICAgICAgICAgICJzZXR0aW5ncyI6IHt9CiAgICAgICAgfQogICAgXSwKICAgICJkbnMiOi\
B7CiAgICAgICAgInNlcnZlcnMiOiBbCiAgICAgICAgICAgICI4LjguOC44IiwKICAgICAgICAgICAg\
IjguOC40LjQiLAogICAgICAgICAgICAibG9jYWxob3N0IgogICAgICAgIF0KICAgIH0KfQ==' > config

ENTRYPOINT [ "./entrypoint.sh" ]
